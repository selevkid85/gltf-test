<!doctype html>
<html lang="ru">
<meta charset="utf-8" />
<title>glTF Viewer</title>
<style>
  html,body{height:100%;margin:0;background:#111;color:#eee;font-family:system-ui,Arial}
  #c{display:block;width:100%;height:100%}
  #ui{position:fixed;left:12px;top:12px;z-index:9;display:flex;gap:8px}
  button{padding:8px 12px;border:0;border-radius:8px;cursor:pointer}
  #log{position:fixed;right:12px;top:12px;background:#0008;padding:8px 12px;border-radius:8px;max-width:40vw}
</style>

<!-- Three.js и загрузчики -->
<script src="https://cdn.jsdelivr.net/npm/three@0.157.0/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.157.0/examples/js/controls/OrbitControls.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.157.0/examples/js/loaders/GLTFLoader.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.157.0/examples/js/loaders/DRACOLoader.js"></script>

<body>
<canvas id="c"></canvas>
<div id="ui">
  <button id="play">Play/Pause</button>
  <button id="recenter">Recenter</button>
</div>
<div id="log"></div>

<script>
const log = (m)=>{ const el=document.getElementById('log'); el.textContent=String(m); console.log(m); };

const canvas = document.getElementById('c');
const renderer = new THREE.WebGLRenderer({canvas, antialias:true});
renderer.setSize(innerWidth, innerHeight);
const scene = new THREE.Scene();
scene.background = new THREE.Color(0x111111);

const camera = new THREE.PerspectiveCamera(60, innerWidth/innerHeight, 0.1, 1000);
camera.position.set(0, 1.2, 3);

const controls = new THREE.OrbitControls(camera, renderer.domElement);
controls.enableDamping = true;

scene.add(new THREE.HemisphereLight(0xffffff, 0x222222, 1.0));
const dir = new THREE.DirectionalLight(0xffffff, 0.9);
dir.position.set(3,5,2);
scene.add(dir);

// Путь к твоей модели
const MODEL_URL = 'butterfly_new.gltf';

const draco = new THREE.DRACOLoader();
draco.setDecoderPath('https://cdn.jsdelivr.net/npm/three@0.157.0/examples/js/libs/draco/');
const loader = new THREE.GLTFLoader();
loader.setDRACOLoader(draco);

let mixer = null, action = null, root = null;

loader.load(MODEL_URL, (gltf)=>{
  root = gltf.scene;
  scene.add(root);

  if (gltf.animations && gltf.animations.length){
    mixer = new THREE.AnimationMixer(root);
    action = mixer.clipAction(gltf.animations[0]);
    action.play();
  }

  // автоцентр камеры
  const box = new THREE.Box3().setFromObject(root);
  if (box.isEmpty() === false){
    const size = box.getSize(new THREE.Vector3()).length();
    const center = box.getCenter(new THREE.Vector3());
    controls.target.copy(center);
    camera.near = size / 100;
    camera.far = size * 100;
    camera.updateProjectionMatrix();
    const dist = size * 1.2;
    const dirVec = new THREE.Vector3(1, 0.6, 1).normalize();
    camera.position.copy(center.clone().add(dirVec.multiplyScalar(dist)));
    controls.update();
  }

  animate();
}, (xhr)=>{
  if (xhr.total) {
    log(`Загрузка: ${Math.round(xhr.loaded / xhr.total * 100)}%`);
  } else {
    log(`Загружено: ${xhr.loaded} байт`);
  }
}, (err)=>{
  log('Ошибка загрузки: ' + (err?.message || err));
});

function animate(){
  requestAnimationFrame(animate);
  const dt = clock.getDelta();
  if (mixer) mixer.update(dt);
  controls.update();
  renderer.render(scene, camera);
}
const clock = new THREE.Clock();

document.getElementById('play').onclick = ()=>{
  if (!action) return;
  action.paused = !action.paused;
};
document.getElementById('recenter').onclick = ()=>{
  if (!root) return;
  const box = new THREE.Box3().setFromObject(root);
  const size = box.getSize(new THREE.Vector3()).length();
  const center = box.getCenter(new THREE.Vector3());
  controls.target.copy(center);
  camera.near = size/100; camera.far = size*100; camera.updateProjectionMatrix();
  const dist = size * 1.2;
  const dirVec = new THREE.Vector3(1, 0.6, 1).normalize();
  camera.position.copy(center.clone().add(dirVec.multiplyScalar(dist)));
  controls.update();
};

addEventListener('resize', ()=>{
  camera.aspect = innerWidth/innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(innerWidth, innerHeight);
});
</script>
</body>
</html>
